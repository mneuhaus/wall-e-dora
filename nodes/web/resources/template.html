<!DOCTYPE html>
<html>
  <head>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <script type="importmap">
      {
        "imports": {
          "@material/web/": "https://esm.run/@material/web/",
          "flatbuffers": "./node_modules/flatbuffers/flatbuffers.mjs"
        }
      }
    </script>
    <script type="module">
      import '@material/web/all.js';
      import {styles as typescaleStyles} from '@material/web/typography/md-typescale-styles.js';
      document.adoptedStyleSheets.push(typescaleStyles.styleSheet);
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>wall-e</title>
    <style>
      body { margin:0; font-family: Roboto, sans-serif; }
      .status-bar { display: flex; align-items: center; justify-content: space-between; background-color: #424242; color: white; padding: 10px 16px; }
      .status-indicator { display: flex; align-items: center; }
      .status-indicator span { margin-left: 8px; }
      .metrics-table { margin: 16px 0; }
      table { width: 100%; border-collapse: collapse; }
      th, td { padding: 8px 12px; border-bottom: 1px solid #ddd; }
      .controls { margin: 16px 0; }
      .badge {margin-right: 10px;}
    </style>

    <script type="module">
      import { Node } from './js/Node.js';
      const node = new Node();
      window.node = node;

      function updateSoundList(sounds) {
        var soundsList = document.getElementById('sounds');
        soundsList.innerHTML = '';
        if (!sounds || !Array.isArray(sounds)) return;
        sounds.forEach(function(sound) {
          var displayName = sound.replace(/\.mp3$/i, '');
          var item = document.createElement('md-list-item');
          item.setAttribute('type', 'button');
          var headline = document.createElement('div');
          headline.setAttribute('slot', 'headline');
          headline.innerText = displayName;
          item.appendChild(headline);
          item.style.cursor = 'pointer';
          item.onclick = function() { node.send_output('play_sound', [sound]); };
          soundsList.appendChild(item);
        });
      }

      function setVolume(volume) {
        node.send_output('set_volume', [volume]);
      }

      setInterval(() => {
        if (node.ws.readyState === WebSocket.OPEN) {
          document.getElementById('connection-active').style.display = '';
          document.getElementById('connection-inactive').style.display = 'none';
        } else {
          document.getElementById('connection-active').style.display = 'none';
          document.getElementById('connection-inactive').style.display = '';
        }
      }, 100);

      node.next((event) => {
        console.log(event);
        if (event.id === 'available_sounds') {
          updateSoundList(event.value);
        }

        if (event.id === 'voltage') {
          document.getElementById('voltage').innerText = parseFloat(event.value).toFixed(2) + " V";
        }

        if (event.id === 'current') {
          document.getElementById('current').innerText = parseFloat(event.value).toFixed(2) + " A";
        }

        if (event.id === 'power') {
          document.getElementById('power').innerText = parseFloat(event.value).toFixed(2) + " W";
        }

        if (event.id === 'soc') {
          document.getElementById('soc').innerText = parseFloat(event.value).toFixed(0) + " %";
        }

        if (event.id === 'runtime') {
          document.getElementById('runtime').innerText = event.value;
        }

        if (event.id === 'shutdown') {
          console.log('Shutdown event received:', event.value);
        }

        if (event.id === 'volume') {
          document.getElementById('volume').value = event.volume;
        }
      })

    </script>
  </head>
  <body>
    <header class="status-bar">
      <div class="status-indicator">
        <span>wall-e</span>
      </div>
      <div id="connection-status">
        <span id="voltage" class="badge" style="font-size: 24px;"></span>
        <span id="current" class="badge" style="font-size: 24px;"></span>
        <span id="power" class="badge" style="font-size: 24px;"></span>
        <span id="soc" class="badge" style="font-size: 24px;"></span>
        <span id="runtime" class="badge" style="font-size: 24px;"></span>
        <span id="connection-active" class="material-symbols-outlined" style="color: #00bfa5; font-size: 40px; display: none;">link</span>
        <span id="connection-inactive" class="material-symbols-outlined" style="color: #e53935; font-size: 40px;">link_off</span>
      </div>
    </header>
      <section class="controls">
        <md-outlined-button onclick="sendButton()">Press me</md-outlined-button>
        <div style="margin-top: 16px;">
          <label for="slider">Adjust value:</label>
          <md-slider id="slider" min="0" max="100" value="50" discrete onchange="sendSlider(this.value)"></md-slider>
        </div>
        <div style="margin-top: 16px;">
          <label for="volume">Volume:</label>
          <md-slider id="volume" min="0" max="1" value="1" step="0.01" discrete onchange="window.node.send_output('set_volume', [this.value]);"></md-slider>
        </div>
      </section>
      <section id="sound-list">
        <h2>Available Sounds</h2>
        <md-list id="sounds"></md-list>
      </section>
    </main>
  </body>
</html>
