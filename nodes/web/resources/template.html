<!DOCTYPE html>
<html>
  <head>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script type="importmap">
      {
        "imports": {
          "@material/web/": "https://esm.run/@material/web/"
        }
      }
    </script>
    <script type="module">
      import '@material/web/all.js';
      import {styles as typescaleStyles} from '@material/web/typography/md-typescale-styles.js';
      document.adoptedStyleSheets.push(typescaleStyles.styleSheet);
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Power Metrics</title>
    <style>
      body { margin:0; font-family: Roboto, sans-serif; }
      .status-bar { display: flex; align-items: center; justify-content: space-between; background-color: #6200ee; color: white; padding: 10px 16px; }
      .status-indicator { display: flex; align-items: center; }
      .status-indicator span { margin-left: 8px; }
      .metrics-table { margin: 16px 0; }
      table { width: 100%; border-collapse: collapse; }
      th, td { padding: 8px 12px; border-bottom: 1px solid #ddd; }
      .controls { margin: 16px 0; }
    </style>
  </head>
  <body>
    <header class="status-bar">
      <div class="status-indicator">
        <md-icon style="color: white;">power</md-icon>
        <span>Power Metrics</span>
      </div>
      <div id="connection-status">
        <md-icon id="status-icon" style="color: red;">cloud_off</md-icon>
      </div>
    </header>
    <main class="container" style="padding: 16px;">
      <section class="metrics-table">
        <table>
          <thead>
            <tr>
              <th>Metric</th>
              <th>Value</th>
            </tr>
          </thead>
          <tbody>
            <tr><td>Voltage</td><td id="voltage">-- V</td></tr>
            <tr><td>Current</td><td id="current">-- A</td></tr>
            <tr><td>Power</td><td id="power">-- W</td></tr>
            <tr><td>SoC</td><td id="soc">-- %</td></tr>
            <tr><td>Runtime</td><td id="runtime">-- s</td></tr>
          </tbody>
        </table>
      </section>
      <section class="controls">
        <md-outlined-button onclick="sendButton()">Press me</md-outlined-button>
        <div style="margin-top: 16px;">
          <label for="slider">Adjust value:</label>
          <md-slider id="slider" min="0" max="100" value="50" discrete onchange="sendSlider(this.value)"></md-slider>
        </div>
        <div style="margin-top: 16px;">
          <label for="volume">Volume:</label>
          <md-slider id="volume" min="0" max="1" value="1" step="0.01" discrete onchange="sendVolume(this.value)"></md-slider>
        </div>
      </section>
      <section id="sound-list">
        <h2>Available Sounds</h2>
        <md-list id="sounds"></md-list>
      </section>
    </main>
    <script src="https://cdn.jsdelivr.net/npm/apache-arrow@11.0.0/dist/arrow.umd.min.js"></script>
    <script type="module">
      import { Node } from './js/Node.js';
      const arrow = window.arrow;
      const node = new Node();
      node.send_output = function(output_id, data, metadata = {}) {
          sendArrowMessage({ action: output_id, value: data });
      };
      var ws;
      function updateMetrics(metrics) {
        document.getElementById('voltage').innerText = metrics.voltage + " V";
        document.getElementById('current').innerText = metrics.current + " A";
        document.getElementById('power').innerText = metrics.power + " W";
        document.getElementById('soc').innerText = metrics.soc + " %";
        document.getElementById('runtime').innerText = metrics.runtime + " s";
      }
      function updateSoundList(sounds) {
        var soundsList = document.getElementById('sounds');
        soundsList.innerHTML = '';
        sounds.forEach(function(sound) {
          var displayName = sound.replace(/\.mp3$/i, '');
          var item = document.createElement('md-list-item');
          item.setAttribute('type', 'button');
          var headline = document.createElement('div');
          headline.setAttribute('slot', 'headline');
          headline.innerText = displayName;
          item.appendChild(headline);
          item.style.cursor = 'pointer';
          item.onclick = function() { sendSound(sound); };
          soundsList.appendChild(item);
        });
      }
      function updateUI(data) {
        updateMetrics(data);
        updateSoundList(data.available_sounds);
        document.getElementById('volume').value = data.volume;
      }
      function connect() {
        ws = new WebSocket('ws://' + location.host + '/ws');
        ws.binaryType = 'arraybuffer';
        ws.onopen = function() {
          updateStatus(true);
        };
        ws.onclose = function() {
          updateStatus(false);
          setTimeout(connect, 1000);
        };
        ws.onerror = function(error) {
          ws.close();
        };
        ws.onmessage = function(event) {
          if (typeof event.data === "string") {
            // Fallback: process as JSON
            try {
              var data = JSON.parse(event.data);
              updateUI(data);
            } catch(e) {
              console.log("Failed to parse JSON metrics:", e);
            }
          } else {
            // Process binary Arrow formatted message
            try {
              var bytes = new Uint8Array(event.data);
              arrow.RecordBatchFileReader.from(bytes).then(function(reader) {
                let batches = [];
                for (const batch of reader) {
                  batches.push(batch);
                }
                if (batches.length > 0) {
                  let obj = batches[0].toObjects()[0];
                  updateUI(obj);
                }
              }).catch(function(e) {
                console.log("Failed to parse Arrow message:", e);
              });
            } catch(e) {
              console.log("Error processing binary message:", e);
            }
          }
        };
      }
      // Utility function to send messages in Arrow format
      function sendArrowMessage(message) {
        const table = arrow.tableFromJSON([message]);
        arrow.RecordBatchWriter.writeAll(table).then(writer => {
          const bytes = writer.toUint8Array();
          ws.send(bytes.buffer);
        }).catch(error => {
          console.log("Error sending Arrow message:", error);
        });
      }
      function updateStatus(connected) {
        var statusIcon = document.getElementById('status-icon');
        if (connected) {
          statusIcon.innerText = "cloud";
          statusIcon.style.color = "green";
        } else {
          statusIcon.innerText = "cloud_off";
          statusIcon.style.color = "red";
        }
      }
      function sendSound(sound) {
          node.send_output("sound_click", sound);
      }
      function sendButton() {
          node.send_output("button", "");
      }
      function sendSlider(value) {
          node.send_output("slider", value);
      }
      function sendVolume(value) {
          node.send_output("set_volume", value);
      }
      connect();
    </script>
  </body>
</html>
