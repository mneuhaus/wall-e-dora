<!DOCTYPE html>
<html>
  <head>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/beercss@3.8.0/dist/cdn/beer.min.css" rel="stylesheet">
    <script type="module" src="https://cdn.jsdelivr.net/npm/beercss@3.8.0/dist/cdn/beer.min.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/material-dynamic-colors@1.1.2/dist/cdn/material-dynamic-colors.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>wall-e</title>
    <style>
      body { margin:0; font-family: Roboto, sans-serif; }
      .status-bar { display: flex; align-items: center; justify-content: space-between; background-color: #424242; color: white; padding: 10px 16px; }
      .status-indicator { display: flex; align-items: center; }
      .status-indicator span { margin-left: 8px; }
      .metrics-table { margin: 16px 0; }
      table { width: 100%; border-collapse: collapse; }
      th, td { padding: 8px 12px; border-bottom: 1px solid #ddd; }
      .controls { margin: 16px 0; }
      .badge {margin-right: 10px;}
    </style>

    <script type="module">
      import { Node } from './js/Node.js';
      const node = new Node();
      window.node = node;

      function updateSoundList(sounds) {
        var soundsList = document.getElementById('sounds');
        soundsList.innerHTML = '';
        if (!sounds || !Array.isArray(sounds)) return;
        sounds.forEach(function(sound) {
          var displayName = sound.replace(/\.mp3$/i, '');
          var item = document.createElement('li');
          item.style.cursor = 'pointer';
          item.innerText = displayName;
          item.onclick = function() { node.send_output('play_sound', [sound]); };
          soundsList.appendChild(item);
        });
      }

      function setVolume(volume) {
        node.send_output('set_volume', [volume]);
      }
    
      setInterval(() => {
        if (node.ws.readyState === WebSocket.OPEN) {
          document.getElementById('connection-active').style.display = '';
          document.getElementById('connection-inactive').style.display = 'none';
        } else {
          document.getElementById('connection-active').style.display = 'none';
          document.getElementById('connection-inactive').style.display = '';
        }
      }, 100);

      node.next((event) => {
        console.log(event);
        if (event.id === 'available_sounds') {
          updateSoundList(event.value);
        }

        if (event.id === 'voltage') {
          document.getElementById('voltage').innerText = parseFloat(event.value).toFixed(2) + " V";
        }

        if (event.id === 'current') {
          document.getElementById('current').innerText = parseFloat(event.value).toFixed(2) + " A";
        }

        if (event.id === 'power') {
          document.getElementById('power').innerText = parseFloat(event.value).toFixed(2) + " W";
        }

        if (event.id === 'soc') {
          document.getElementById('soc').innerText = parseFloat(event.value).toFixed(0) + " %";
        }

        if (event.id === 'runtime') {
          document.getElementById('runtime').innerText = event.value;
        }

        if (event.id === 'shutdown') {
          console.log('Shutdown event received:', event.value);
        }

        if (event.id === 'volume') {
          document.getElementById('volume').value = event.volume;
        }
      })

      window.addEventListener('DOMContentLoaded', () => {
          document.querySelectorAll('.slider input[type="range"]').forEach(input => {
              input.dispatchEvent(new Event('change'));
          });
      });

    </script>
  </head>
  <body>
    <header class="top-app-bar" style="display: flex; align-items: center; justify-content: space-between; padding: 0 16px; background-color: #424242; color: white;">
      <div class="top-app-bar__title" style="font-size: 24px;">wall-e</div>
      <div class="media-controls" style="display: flex; align-items: center;">
          <label class="slider" style="margin: 0 16px;">
            <input type="range" id="volume" min="0" max="1" value="1" step="0.01" onchange="window.node.send_output('set_volume', [this.value]);">
            <span></span>
          </label>
          <button onclick="window.node.send_output('stop', []);" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">
            <i class="fa-solid fa-stop"></i>
          </button>
      </div>
      <div class="top-app-bar__actions">
        <span id="voltage" style="font-size: 18px; margin-right: 8px;"></span>
        <span id="current" style="font-size: 18px; margin-right: 8px;"></span>
        <span id="power" style="font-size: 18px; margin-right: 8px;"></span>
        <span id="soc" style="font-size: 18px; margin-right: 8px;"></span>
        <span id="runtime" style="font-size: 18px;"></span>
        <span id="connection-active" style="color: #00bfa5; font-size: 24px; display: none; margin-left: 16px;"><i class="fa-solid fa-link"></i></span>
        <span id="connection-inactive" style="color: #e53935; font-size: 24px; margin-left: 16px;"><i class="fa-solid fa-link-slash"></i></span>
      </div>
    </header>
      
      <section id="sound-list">
        <h2>Available Sounds</h2>
        <ul id="sounds"></ul>
      </section>
    </main>
  </body>
</html>
